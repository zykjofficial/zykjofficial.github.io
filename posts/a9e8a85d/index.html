<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Vue响应式原理解读 | 卓越科技的Blog</title><meta name="keywords" content="Vue"><meta name="author" content="卓越科技-"><meta name="copyright" content="卓越科技-"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="学习了Vue的基础知识、了解一下Vue的响应式原理吧"><meta property="og:type" content="article"><meta property="og:title" content="Vue响应式原理解读"><meta property="og:url" content="https://blog.imzykj.cn/posts/a9e8a85d/index.html"><meta property="og:site_name" content="卓越科技的Blog"><meta property="og:description" content="学习了Vue的基础知识、了解一下Vue的响应式原理吧"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://tva4.sinaimg.cn/large/9bd9b167gy1fwrtnow7fgj21hc0u0nki.jpg"><meta property="article:published_time" content="2020-08-05T12:20:13.000Z"><meta property="article:modified_time" content="2020-08-08T15:23:13.000Z"><meta property="article:author" content="卓越科技-"><meta property="article:tag" content="Vue"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://tva4.sinaimg.cn/large/9bd9b167gy1fwrtnow7fgj21hc0u0nki.jpg"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/zykjofficial/zykjofficial.github.io@master/img/favicon.ico"><link rel="canonical" href="https://blog.imzykj.cn/posts/a9e8a85d/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><meta name="baidu_site_verification" content="code-mj8vk6WNEX"><link rel="manifest" href="/img/pwa/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/img/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/pwa/32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/pwa/16.png"><link rel="mask-icon" href="/img/pwa/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zykjofficial/zykjofficial.github.io@master/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?522f612b854f8880484c7f561eff3399";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:{limitDay:30,position:"top",messagePrev:"这篇文章已经发表了",messageNext:"天了，其中某些内容可能已经过时。"},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"top-center"},source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.neta/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isanchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Vue响应式原理解读",isPost:!0,isHome:!1,isHighlightShrink:!0,isToc:!0,postUpdate:"2020-08-08 23:23:13"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const a=864e5*o,c={value:t,expiry:(new Date).getTime()+a};localStorage.setItem(e,JSON.stringify(c))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.onerror=o,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme"),o=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!o&&!a&&!c;if(void 0===t){if(a)activateLightMode();else if(o)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener((function(e){void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())}))}else"light"===t?activateLightMode():activateDarkMode();const i=saveToLocal.get("aside-status");void 0!==i&&("hide"===i?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));const r=saveToLocal.get("global-font-size");void 0!==r&&document.documentElement.style.setProperty("--global-font-size",r+"px")})(window)</script><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zykjofficial/zykjofficial.github.io@master/css/zykjcss.css" media="all" onload='this.media="all",this.onload=null'><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="卓越科技的Blog" type="application/atom+xml"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjofficial.github.io@master/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">51</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-house-user"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-book"></i> <span>文章</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="/random_post/"><i class="fa-fw fas fa-random"></i> <span>随机文章</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-tasks"></i> <span>导航</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/nav/"><i class="fa-fw fa fa-bookmark"></i> <span>网站导航</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-th-list"></i> <span>娱乐</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa fa-film"></i> <span>番剧</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fa fa-image"></i> <span>相册</span></a></li><li><a class="site-page child" href="/mikutap/"><i class="fa-fw fas fa-snowflake"></i> <span>Mikutap</span></a></li><li><a class="site-page child" href="/api/"><i class="fa-fw fas fa-atom"></i> <span>随机二次元</span></a></li><li><a class="site-page child" href="/baidu/"><i class="fa-fw fa-fw fab fa-html5"></i> <span>百度一下</span></a></li><li><a class="site-page child" href="/random/"><i class="fa-fw fas fa-random"></i> <span>随机选人</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-gamepad"></i> <span>游戏</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/game/arknights/"><i class="fa-fw fa fa-mobile"></i> <span>明日方舟</span></a></li><li><a class="site-page child" href="/catchcat/"><i class="fa-fw fa fa-cat"></i> <span>圈小猫</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-envelope"></i> <span>消息</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/message/"><i class="fa-fw fa fa-comments"></i> <span>留言板</span></a></li><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-eject"></i> <span>说说</span></a></li><li><a class="site-page child" href="/timeline/"><i class="fa-fw far fa-calendar-alt"></i> <span>时间线</span></a></li><li><a class="site-page child" href="/friendcircle/"><i class="fa-fw fas fa-heartbeat"></i> <span>友链朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fab fa-ubuntu"></i> <span>镜像站</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://zykjofficial.github.io/"><i class="fa-fw fab fa-github"></i> <span>Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://414kjf.coding-pages.com"><i class="fa-fw fas fa-dice-d20"></i> <span>Coding</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://zykjofficial.gitee.io/"><i class="fa-fw fas fa-gopuram"></i> <span>Gitee</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://zykj.now.sh/"><i class="fa-fw fas fa-khanda"></i> <span>Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://zykj.netlify.app/"><i class="fa-fw fas fa-spa"></i> <span>Netlify</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-info-circle"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://tva4.sinaimg.cn/large/9bd9b167gy1fwrtnow7fgj21hc0u0nki.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">卓越科技的Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-house-user"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-book"></i> <span>文章</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="/random_post/"><i class="fa-fw fas fa-random"></i> <span>随机文章</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-tasks"></i> <span>导航</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/nav/"><i class="fa-fw fa fa-bookmark"></i> <span>网站导航</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-th-list"></i> <span>娱乐</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa fa-film"></i> <span>番剧</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fa fa-image"></i> <span>相册</span></a></li><li><a class="site-page child" href="/mikutap/"><i class="fa-fw fas fa-snowflake"></i> <span>Mikutap</span></a></li><li><a class="site-page child" href="/api/"><i class="fa-fw fas fa-atom"></i> <span>随机二次元</span></a></li><li><a class="site-page child" href="/baidu/"><i class="fa-fw fa-fw fab fa-html5"></i> <span>百度一下</span></a></li><li><a class="site-page child" href="/random/"><i class="fa-fw fas fa-random"></i> <span>随机选人</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-gamepad"></i> <span>游戏</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/game/arknights/"><i class="fa-fw fa fa-mobile"></i> <span>明日方舟</span></a></li><li><a class="site-page child" href="/catchcat/"><i class="fa-fw fa fa-cat"></i> <span>圈小猫</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-envelope"></i> <span>消息</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/message/"><i class="fa-fw fa fa-comments"></i> <span>留言板</span></a></li><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-eject"></i> <span>说说</span></a></li><li><a class="site-page child" href="/timeline/"><i class="fa-fw far fa-calendar-alt"></i> <span>时间线</span></a></li><li><a class="site-page child" href="/friendcircle/"><i class="fa-fw fas fa-heartbeat"></i> <span>友链朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fab fa-ubuntu"></i> <span>镜像站</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://zykjofficial.github.io/"><i class="fa-fw fab fa-github"></i> <span>Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://414kjf.coding-pages.com"><i class="fa-fw fas fa-dice-d20"></i> <span>Coding</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://zykjofficial.gitee.io/"><i class="fa-fw fas fa-gopuram"></i> <span>Gitee</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://zykj.now.sh/"><i class="fa-fw fas fa-khanda"></i> <span>Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://zykj.netlify.app/"><i class="fa-fw fas fa-spa"></i> <span>Netlify</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-info-circle"></i> <span>关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Vue响应式原理解读</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-08-05T12:20:13.000Z" title="发表于 2020-08-05 20:20:13">2020-08-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-08-08T15:23:13.000Z" title="更新于 2020-08-08 23:23:13">2020-08-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web%E6%95%99%E7%A8%8B/">Web教程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web%E6%95%99%E7%A8%8B/Vue/">Vue</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>封面P站: <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.pixiv.net/artworks/83495208">https://www.pixiv.net/artworks/83495208</a></p><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cn.vuejs.org/images/data.png" alt="响应式原理"></p><p>这张图片是Vue官方响应式图片、像我这样的菜鸡是很难理解的、所有我通过查阅资料和看视频来理解Vue响应式、虽然并不能完全看懂、但是尽自己所能总结出自己的想法吧！！！</p><h2 id="Vue响应式原理解读"><a href="#Vue响应式原理解读" class="headerlink" title="Vue响应式原理解读"></a>Vue响应式原理解读</h2><div class="note info flat"><p>什么是响应式？</p><p><code>响应式就是当数据发生改变时、视图也会跟着更新</code></p></div><p>Vue响应式原理是<code>数据劫持</code>和<code>发布订阅模式</code></p><ul><li>Vue2.0时使用的ES5中的<code>Object.defineProperty</code>设置对象属性的<code>set/get</code>方法来监听数据的变化</li><li>Vue3.0的时使用的ES6中的<code>Proxy</code>实现数据劫持</li><li>观察者模式</li></ul><p>下面我们就通过最直观的方法来了解Vue响应式的原理吧</p><h3 id="Object-defineProperty"><a href="#Object-defineProperty" class="headerlink" title="Object.defineProperty"></a>Object.defineProperty</h3><p>基本语法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.defineProperty(obj, prop, descriptor)</span><br></pre></td></tr></table></figure><p><code>参数</code></p><ul><li><code>obj</code>要定义属性的对象。</li><li><code>prop</code>要定义或修改的属性的名称或 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Symbol"><code>Symbol</code></a> 。</li><li><code>descriptor</code>要定义或修改的属性描述符。</li></ul><p><code>descriptor</code>属性修饰符:</p><table><thead><tr><th>修饰符</th><th>说明</th></tr></thead><tbody><tr><td><code>configurable</code></td><td>为 <code>true</code> 时，该属性也能从对应的对象上被删除(delete)。 默认为 <code>false</code>。</td></tr><tr><td><code>enumerable</code></td><td>为<code>true</code> 可以被遍历。默认为 <code>false</code></td></tr><tr><td>数据描述符还具有以下可选键值：</td><td></td></tr><tr><td><code>value</code></td><td>该属性对应的值。默认为 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/undefined"><code>undefined</code></a>。</td></tr><tr><td><code>writable</code></td><td>为 <code>true</code> 时，属性值<code>value</code>才能被<a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Assignment_Operators"><code>赋值运算符</code></a>改变。 默认为 <code>false</code>。存在改属性是不能有<code>get、set</code></td></tr><tr><td>存取描述符还具有以下可选键值：</td><td></td></tr><tr><td><code>get</code></td><td>属性的 getter 函数，如果没有 getter，则为 <code>undefined</code>。当访问该属性时，会调用此函数。执行时不传入任何参数，但是会传入 <code>this</code> 对象（由于继承关系，这里的<code>this</code>并不一定是定义该属性的对象）。该函数的返回值会被用作属性的值。 默认为 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/undefined"><code>undefined</code></a>。</td></tr><tr><td><code>set</code></td><td>属性的 setter 函数，如果没有 setter，则为 <code>undefined</code>。当属性值被修改时，会调用此函数。该方法接受一个参数（也就是被赋予的新值），会传入赋值时的 <code>this</code> 对象。 默认为 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/undefined"><code>undefined</code></a>。</td></tr></tbody></table><p>简单的例子:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> value;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(obj, <span class="string">&quot;name&quot;</span>, &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newValue</span>)</span> &#123;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;触发set方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> newValue;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;触发set方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">obj.name = <span class="string">&quot;zykj&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.name);</span><br></pre></td></tr></table></figure><p>最终打印:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">触发set方法</span><br><span class="line">触发set方法</span><br><span class="line">zykj</span><br></pre></td></tr></table></figure><p>在Vue2.0中我们使用<code>Object.defineProperty</code>给data中的属性加上<code>get、set</code>方法实现数据劫持</p><h3 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h3><blockquote><p><code>观察者模式</code>又称<code>发布订阅模式(只是观察者模式的一个别称。)</code>，它定义了对象间的一种<code>一对多</code>的关系，让多个观察者对象同时监听某一个主题对象，当一个对象发生改变时，所有依赖于它的对象都将得到通知。</p></blockquote><ul><li><p>优点：更加解耦，支持广播通信</p></li><li><p>缺点：大量观察者，广播有性能问题</p></li></ul><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg@master/img/20200808165331.png" alt="图解"></p><p>这里就简单理解一下 参考: <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/qq_25800235/article/details/86659422">https://blog.csdn.net/qq_25800235/article/details/86659422</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span>  </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">name</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;数据修改了&quot;</span>+data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">name</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name</span><br><span class="line">        <span class="comment">//用于存放观察者</span></span><br><span class="line">        <span class="built_in">this</span>.observers = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">addObserver</span>(<span class="params">observer</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.observers.push(observer)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">removeObserver</span>(<span class="params">observer</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> index = <span class="built_in">this</span>.observers.indexOf(observer)</span><br><span class="line">        <span class="built_in">this</span>.observers.splice(index, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">notify</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.observers.forEach(<span class="function">(<span class="params">observer</span>) =&gt;</span> &#123;</span><br><span class="line">            observer.update(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ob1 = <span class="keyword">new</span> Observer (<span class="string">&#x27;ob1&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> ob2 = <span class="keyword">new</span> Observer (<span class="string">&#x27;ob2&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> sub = <span class="keyword">new</span> Subject(<span class="string">&#x27;sub&#x27;</span>);</span><br><span class="line">sub.addObserver(ob1);</span><br><span class="line">sub.addObserver(ob2);</span><br><span class="line">sub.notify(<span class="string">&#x27;some context&#x27;</span>); <span class="comment">// 数据修改了some context</span></span><br></pre></td></tr></table></figure><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>我将从以下几个方面来实现：</p><ul><li><p>初始化Vue</p></li><li><p>编译模板：将指令转换为数据</p></li><li><p>数据劫持：通过<code>Object.defineProperty</code>对每个数据添加get/set方法</p></li><li><p>数据代理：可以直接通过<code>vue</code>实例访问<code>data</code>中的数据、例: <code>vue.people.name</code> 与<code>vue.$data.people.name</code></p></li><li><p>发布订阅模式: 通知观察者更新数据</p></li></ul><h4 id="初始化Vue"><a href="#初始化Vue" class="headerlink" title="初始化Vue"></a>初始化Vue</h4><p>html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;people.name&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123; people.name &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;&#123; people.age &#125;&#125;</span><br><span class="line">    &#123;&#123; getName &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-html</span>=<span class="string">&quot;message&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-on:click</span>=<span class="string">&quot;change&quot;</span>&gt;</span>更新<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>首先我们需要有一个vue实例</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vue = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">&quot;#app&quot;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        people: &#123;</span><br><span class="line">            name: <span class="string">&#x27;zykj&#x27;</span>,</span><br><span class="line">            age: <span class="number">18</span></span><br><span class="line">        &#125;,</span><br><span class="line">        message: <span class="string">&quot;&lt;h1&gt;哈哈哈哈&lt;/h1&gt;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    computed: &#123;</span><br><span class="line">        <span class="function"><span class="title">getName</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;我是&quot;</span> + <span class="built_in">this</span>.people.name</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        <span class="function"><span class="title">change</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.people.age = <span class="number">20</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>那我就创建一个<code>Vue</code>类、模仿Vue默认传入<code>options</code>对象、并且对<code>el</code>和<code>data</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.$el = options.el</span><br><span class="line">        <span class="built_in">this</span>.$data = options.data</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="编译模板"><a href="#编译模板" class="headerlink" title="编译模板"></a>编译模板</h4><p>我们需要在<code>el</code>存在时对模板进行编译、这时我们准备一个<code>Compile</code>进行编译模板、构造函数中需要传入<code>el</code>和<code>当前对象(this)</code></p><ol><li><p>首先是对传入的<code>el</code>(可能传入: <code>#app</code>或者<code>document.querySelector(&quot;#app&quot;)</code>)进行判断、封装一个函数来判断是否为元素节点<code>(nodeType = 1)</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否为元素节点</span></span><br><span class="line"><span class="function"><span class="title">isElementNode</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// nodeType 为 1 是元素节点</span></span><br><span class="line">    <span class="keyword">return</span> node.nodeType === <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>因为我们需要对所有节点进行分析、频繁操作会影响性能、可以创建一个<code>文档碎片 document.createDocumentFragment()</code>、遍历每个节点并且<code>添加appendChild</code>到文档碎片中、每次获取第一个节点<code>firstChild</code>并去除、可以依次放入文档碎片中、对每个元素替换完之后再放回<code>appendChild</code>Dom中</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将el中的元素放入文档碎片(内存)中</span></span><br><span class="line"><span class="function"><span class="title">node2fragment</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 创建文档碎片</span></span><br><span class="line">    <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line">    <span class="keyword">let</span> firstChild;</span><br><span class="line">    <span class="comment">// 通过每次获取第一个元素来将所有元素添加到文档碎片中</span></span><br><span class="line">    <span class="keyword">while</span> (firstChild = node.firstChild) &#123;</span><br><span class="line">        <span class="comment">// appendChild 具有移动性 可以将页面中的元素移动到文档碎片中</span></span><br><span class="line">        fragment.appendChild(firstChild)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fragment</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>把内容放入文档碎片后、对文档中的数据进行编译：双大括号里的内容转换成真正的数据、<code>compile方法</code>编译、获取<code>Fragment</code>中的中的所有<code>子节点childNodes</code>(返回一个伪数组)、通过扩展运算符(…) 转换成为数组再进行遍历得到每一项(child) 进行判断是否为元素节点(<code>isElementNode</code>)或者是文本节点</p><ul><li><p>如果是<code>元素节点</code>：我们首先遍历的是第一层元素(并且编译元素节点<code>compileElementNode</code>)</p></li><li><p>如果还有子元素、我们需要再进行递归<code>子元素</code>、如果是<code>文本节点</code>: 调用<code>compileText</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//编译模板</span></span><br><span class="line"><span class="function"><span class="title">compile</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取子节点  返回的是一个伪数组</span></span><br><span class="line">    <span class="keyword">let</span> childNodes = node.childNodes; <span class="comment">// NodeList(7) [text, input, text, div, text, ul, text]</span></span><br><span class="line">    <span class="comment">// 通过...转成 数组</span></span><br><span class="line">    [...childNodes].forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//判断是为元素节点 如 &lt;input type=&quot;text&quot; v-model=&quot;people.name&quot;&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isElementNode(child)) &#123;</span><br><span class="line">            <span class="comment">// 编译元素节点</span></span><br><span class="line">            <span class="built_in">this</span>.compileElementNode(child);</span><br><span class="line">            <span class="comment">// 如果是元素 需要判断自己的子节点 (递归)</span></span><br><span class="line">            <span class="built_in">this</span>.compile(child)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 编译文本节点</span></span><br><span class="line">            <span class="built_in">this</span>.compileText(child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>再来实现一下这两个方法</p><p><code>compileElementNode</code></p><ul><li><p>到这里了我们可以确定获取到<code>&lt;input type=&quot;text&quot; v-model=&quot;people.name&quot;&gt;</code>、开始获取每个<code>属性值(attributes)</code></p></li><li><p>同样进行<code>遍历</code>得到每个属性(是以对象形式的、name为key、value是value)、进行解构赋值(把<code>value</code>重新命名为<code>expr</code>)</p></li><li><p>判断是否以<code>v-</code>开头的(<code>isDirective</code>)、获取到<code>v-model</code>在进行(<code>-</code>)分割得到对应的<code>指令directive:事件</code>、当然如果是<code>v-on:click</code>需要再进行分隔得到<code>directiveName</code>和事件名<code>eventName</code>、需要一个<code>工具类CompileUtil</code>将<code>表达式expr(people.name)</code> 替换成对应的数据、<code>expr</code>去除两边空格</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译元素</span></span><br><span class="line"><span class="function"><span class="title">compileElementNode</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 返回的是一个伪数组</span></span><br><span class="line">    <span class="keyword">let</span> attributes = node.attributes;</span><br><span class="line">    [...attributes].forEach(<span class="function">(<span class="params">attr</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 通过解构赋值获取 name(type) 和 value(text) </span></span><br><span class="line">        <span class="keyword">let</span> &#123; name, <span class="attr">value</span>: expr &#125; = attr;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isDirective(name)) &#123;</span><br><span class="line">            <span class="comment">//获取指令、 如 v-model 获取 model v-on:click</span></span><br><span class="line">            <span class="keyword">let</span> [, directive] = name.split(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">            <span class="keyword">let</span> [directiveName, eventName] = directive.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">            CompileUtil[directiveName](node, expr.trim(), <span class="built_in">this</span>.vm, eventName)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//判断是否为指令</span></span><br><span class="line"><span class="function"><span class="title">isDirective</span>(<span class="params">attrName</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//ES6 语法 判断是否以 v- 开头</span></span><br><span class="line">    <span class="keyword">return</span> attrName.startsWith(<span class="string">&quot;v-&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>compileText</code></p><p><code>文本节点</code>通过<code>textContent</code>获取文本内容、得到的内容我们需要判断是否含有 &#123;&#123; people.name &#125;&#125; 、通过正则表达式<code>/\&#123;\&#123;(.+?)\&#125;\&#125;/</code>判断、再通过<code>工具类CompileUtil</code>将<code>表达式expr(people.name)</code> 替换成对应的数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译文本</span></span><br><span class="line"><span class="function"><span class="title">compileText</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> content = node.textContent; <span class="comment">// 获取文本内容</span></span><br><span class="line">    <span class="comment">//匹配 &#123;&#123; xxx &#125;&#125; .+? 匹配(任意字符重复一次或更多次)再重复0次或一次避免匹配 &#123;&#123; aaa &#125;&#125; &#123;&#123; bbb &#125;&#125;</span></span><br><span class="line">    <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.+?)\&#125;\&#125;/</span>;</span><br><span class="line">    <span class="keyword">if</span> (reg.test(content)) &#123;</span><br><span class="line">        CompileUtil[<span class="string">&#x27;text&#x27;</span>](node, content, <span class="built_in">this</span>.vm)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>工具类<code>CompileUtil</code></p><p>通过不同指令执行不同的方法:</p><p>首先对<code>CompileUtil[directiveName](node, expr.trim(), this.vm, eventName)</code>进行分析：</p><p>为了确保能够正确的设置值和获取值我们需要准备<code>getVal(vm, expr)</code>和<code>setVal(vm, expr, value)</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">getVal</span>(<span class="params">vm, expr</span>)</span> &#123; <span class="comment">// 我们以 people.name 进行分析</span></span><br><span class="line">    <span class="keyword">return</span> expr.split(<span class="string">&quot;.&quot;</span>).reduce(<span class="function">(<span class="params">data, current</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">/* data 前一项数据 current 当前数据</span></span><br><span class="line"><span class="comment">        第一次 从 vm.$data[people] 返回 people: &#123; name: 18 &#125;</span></span><br><span class="line"><span class="comment">        第二次 people[name] 得到 18</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">return</span> data[current];</span><br><span class="line">    &#125;, vm.$data<span class="comment">/*这里为初始的值*/</span>)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="function"><span class="title">setVal</span>(<span class="params">vm, expr, value</span>)</span> &#123; <span class="comment">// 将 people.name 设置为新值</span></span><br><span class="line">    expr.split(<span class="string">&quot;.&quot;</span>).reduce(<span class="function">(<span class="params">data, current, index, arr</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (index == arr.length - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 只有当前索引等于数组的最后一项的索引 将修改数据 people[name] = value</span></span><br><span class="line">            <span class="keyword">return</span> data[current] = value</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data[current]</span><br><span class="line">    &#125;, vm.$data)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>以及修改值的方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//工具类替换模板内容</span></span><br><span class="line">CompileUtil = &#123;</span><br><span class="line">    <span class="comment">//... </span></span><br><span class="line">    <span class="comment">//更新数据</span></span><br><span class="line">    updater: &#123;</span><br><span class="line">        <span class="comment">// v-mdoel 数据修改</span></span><br><span class="line">        <span class="function"><span class="title">modelUpdater</span>(<span class="params">node, value</span>)</span> &#123;</span><br><span class="line">            node.value = value;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 文本数据修改</span></span><br><span class="line">        <span class="function"><span class="title">textUpdater</span>(<span class="params">node, value</span>)</span> &#123;</span><br><span class="line">            node.textContent = value</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// v-html 数据修改</span></span><br><span class="line">        <span class="function"><span class="title">htmlUpdater</span>(<span class="params">node,value</span>)</span>&#123;</span><br><span class="line">            node.innerHTML = value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>v-model</code>指令 <code>model方法</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-model 指令  node为元素节点、expr为表达式(people.name)、vm当前实例</span></span><br><span class="line"><span class="function"><span class="title">model</span>(<span class="params">node, expr, vm</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;modelUpdater&#x27;</span>]</span><br><span class="line">	<span class="comment">// 给input 赋予 value 属性 node.value = xxx</span></span><br><span class="line">	<span class="keyword">let</span> val = <span class="built_in">this</span>.getVal(vm, expr)</span><br><span class="line">	<span class="comment">//监听事件</span></span><br><span class="line">	node.addEventListener(<span class="string">&#x27;input&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="comment">//值修改时修改数据</span></span><br><span class="line">		<span class="built_in">this</span>.setVal(vm, expr, event.target.value)</span><br><span class="line">	&#125;)</span><br><span class="line">	fn(node, val)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></li><li><p>&#123;&#123;  &#125;&#125; 模板 <code>text</code>方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">text</span>(<span class="params">node, expr, vm</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;textUpdater&#x27;</span>]</span><br><span class="line">    <span class="comment">// 通过 replace 将 &#123;&#123; people.name &#125;&#125; 替换为对应的值</span></span><br><span class="line">    <span class="keyword">let</span> content = expr.replace(<span class="regexp">/\&#123;\&#123;(.+?)\&#125;\&#125;/g</span>, <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// args[1]: args 是一个数组、第二个参数是匹配到的内容</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getVal(vm, args[<span class="number">1</span>].trim())</span><br><span class="line">    &#125;)</span><br><span class="line">    fn(node, content)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></li><li><p><code>v-on:click</code>指令<code>on方法</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">on</span>(<span class="params">node, expr, vm, eventName</span>)</span> &#123;</span><br><span class="line">    node.addEventListener(eventName, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 相当于 vue[change]()</span></span><br><span class="line">        vm[expr].call(vm, event)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></li><li><p><code>v-html</code> 指令<code>html</code>方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">html</span>(<span class="params">node,expr,vm</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;htmlUpdater&#x27;</span>]</span><br><span class="line">    <span class="comment">// 给input 赋予 value 属性 node.value = xxx</span></span><br><span class="line">    <span class="keyword">let</span> val = <span class="built_in">this</span>.getVal(vm, expr)</span><br><span class="line">    fn(node, val)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></li><li><p>完整代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//工具类替换模板内容</span></span><br><span class="line">CompileUtil = &#123;</span><br><span class="line">    <span class="function"><span class="title">getVal</span>(<span class="params">vm, expr</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> expr.split(<span class="string">&quot;.&quot;</span>).reduce(<span class="function">(<span class="params">data, current</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> data[current];</span><br><span class="line">        &#125;, vm.$data)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">setVal</span>(<span class="params">vm, expr, value</span>)</span> &#123;</span><br><span class="line">        expr.split(<span class="string">&quot;.&quot;</span>).reduce(<span class="function">(<span class="params">data, current, index, arr</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (index == arr.length - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> data[current] = value</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> data[current]</span><br><span class="line">        &#125;, vm.$data)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// v-model 指令  node为元素节点、expr为表达式(people.name)、vm当前实例</span></span><br><span class="line">    <span class="function"><span class="title">model</span>(<span class="params">node, expr, vm</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;modelUpdater&#x27;</span>]</span><br><span class="line">        <span class="comment">// 给input 赋予 value 属性 node.value = xxx</span></span><br><span class="line">        <span class="keyword">let</span> val = <span class="built_in">this</span>.getVal(vm, expr)</span><br><span class="line">        node.addEventListener(<span class="string">&#x27;input&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setVal(vm, expr, event.target.value)</span><br><span class="line">        &#125;)</span><br><span class="line">        fn(node, val)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">on</span>(<span class="params">node, expr, vm, eventName</span>)</span> &#123;</span><br><span class="line">        node.addEventListener(eventName, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            vm[expr].call(vm, event)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">html</span>(<span class="params">node,expr,vm</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;htmlUpdater&#x27;</span>]</span><br><span class="line">        <span class="comment">// 给input 赋予 value 属性 node.value = xxx</span></span><br><span class="line">        <span class="keyword">let</span> val = <span class="built_in">this</span>.getVal(vm, expr)</span><br><span class="line">        fn(node, val)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">text</span>(<span class="params">node, expr, vm</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;textUpdater&#x27;</span>]</span><br><span class="line">        <span class="comment">// 通过 replace 将 &#123;&#123; people.name &#125;&#125; 替换为对应的值</span></span><br><span class="line">        <span class="keyword">let</span> content = expr.replace(<span class="regexp">/\&#123;\&#123;(.+?)\&#125;\&#125;/g</span>, <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// args[1]: args 是一个数组、第二个参数是匹配到的内容</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getVal(vm, args[<span class="number">1</span>].trim())</span><br><span class="line">        &#125;)</span><br><span class="line">        fn(node, content)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//更新数据</span></span><br><span class="line">    updater: &#123;</span><br><span class="line">        <span class="function"><span class="title">modelUpdater</span>(<span class="params">node, value</span>)</span> &#123;</span><br><span class="line">            node.value = value;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">textUpdater</span>(<span class="params">node, value</span>)</span> &#123;</span><br><span class="line">            node.textContent = value</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">htmlUpdater</span>(<span class="params">node,value</span>)</span>&#123;</span><br><span class="line">            node.innerHTML = value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ol><h4 id="数据劫持"><a href="#数据劫持" class="headerlink" title="数据劫持"></a>数据劫持</h4><p>在我们判断数据是否存在时、首先需要给所有数据添加<code>set/get</code>、通过<code>Observer类</code></p><ul><li><code>observer(data)</code>方法 首先判断data是否存在并且是否为对象类型、是就进行<code>for in</code>遍历、<code>Recative</code>化</li><li>通过<code>Object.defineProperty</code>添加get和set方法</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 改类实现数据劫持、添加set/get方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.observer(data)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">observer</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (data &amp;&amp; <span class="keyword">typeof</span> data == <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> data) &#123;</span><br><span class="line">                <span class="built_in">this</span>.defineRecative(key, data, data[key])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">defineRecative</span>(<span class="params">key, data, value</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 每次添加set/get方法时还需要递归遍历 如 people:&#123; zykj: &#123; age: 18 &#125;  &#125; </span></span><br><span class="line">        <span class="built_in">this</span>.observer(value)</span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(data, key, &#123;</span><br><span class="line">            configurable: <span class="literal">true</span>,</span><br><span class="line">            enumerable: <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">// 因为普通函数的this的指向为当前对象</span></span><br><span class="line">            <span class="comment">// 我们使用箭头函数将this指向函数定义在的对象里 </span></span><br><span class="line">            set: <span class="function">(<span class="params">newValue</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (newValue !== value) &#123;</span><br><span class="line">                    <span class="comment">// 给修改的新值重新添加get/set</span></span><br><span class="line">                    <span class="built_in">this</span>.observer(newValue)</span><br><span class="line">                    value = newValue</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="数据代理"><a href="#数据代理" class="headerlink" title="数据代理"></a>数据代理</h4><p>使用过vue我们可以知道、<code>上面的示例中</code>、可以通过<code>vue.people.name</code>、访问到数据、这样就进行了代理</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//代理 使得 通过 vue.people.name 访问和修改数据</span></span><br><span class="line"><span class="function"><span class="title">proxyData</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> data) &#123;</span><br><span class="line">        <span class="comment">// 这里第一个参数 this就是vue示例 通过vue访问到 vue.$data中的数据</span></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(<span class="built_in">this</span>, key, &#123;</span><br><span class="line">            configurable: <span class="literal">true</span>,</span><br><span class="line">            enumerable: <span class="literal">true</span>,</span><br><span class="line">            <span class="function"><span class="title">set</span>(<span class="params">newValue</span>)</span> &#123;</span><br><span class="line">                data[key] = newValue</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> data[key]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="发布订阅模式"><a href="#发布订阅模式" class="headerlink" title="发布订阅模式"></a>发布订阅模式</h4><p><code>Watcher</code>类似vue中的<code>watch</code>、可以监听数据的变化</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">watch:&#123;</span><br><span class="line">    <span class="string">&#x27;data中的数据&#x27;</span>(newValue,oldValue)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时需要<code>Watcher</code>来监听数据的变化来做出相应的改变</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (观察者) 发布订阅模式</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">vm, expr, callback</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.vm = vm;</span><br><span class="line">        <span class="built_in">this</span>.expr = expr.trim();</span><br><span class="line">        <span class="comment">// 回调函数 当数据发送变化时传入新值进行改变</span></span><br><span class="line">        <span class="built_in">this</span>.callback = callback</span><br><span class="line">        <span class="comment">// 保存变化之前的值</span></span><br><span class="line">        <span class="built_in">this</span>.oldValue = <span class="built_in">this</span>.get()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">//依赖注入 将 当前对象存入 Dep.target 中</span></span><br><span class="line">        Dep.target = <span class="built_in">this</span></span><br><span class="line">        <span class="keyword">let</span> value = CompileUtil.getVal(<span class="built_in">this</span>.vm, <span class="built_in">this</span>.expr)</span><br><span class="line">        Dep.target = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> newValue = CompileUtil.getVal(<span class="built_in">this</span>.vm, <span class="built_in">this</span>.expr)</span><br><span class="line">        <span class="comment">// 当 新值和旧值不相同时才进行回调</span></span><br><span class="line">        <span class="keyword">if</span> (newValue != <span class="built_in">this</span>.oldValue) &#123;</span><br><span class="line">            <span class="built_in">this</span>.callback(newValue)</span><br><span class="line">            <span class="built_in">this</span>.oldValue = newValue</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Dep 用于存放 Watcher 来通知 数据更新</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于通知观察者更新数据</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">//用于存放 Watcher</span></span><br><span class="line">        <span class="built_in">this</span>.subs = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将观察者添加进一个数组里</span></span><br><span class="line">    <span class="function"><span class="title">addSub</span>(<span class="params">watcher</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subs.push(watcher)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通知每个 watcher进行数据更新</span></span><br><span class="line">    <span class="function"><span class="title">notify</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subs.forEach(<span class="function">(<span class="params">watcher</span>) =&gt;</span> watcher.update())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>问题何时 创建 Dep 和 Watcher</p><p>创建<code>Dep</code>需要在数据劫持时</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">defineRecative</span>(<span class="params">key, data, value</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.observer(value)</span><br><span class="line">    <span class="keyword">let</span> dep = <span class="keyword">new</span> Dep() <span class="comment">//给每个属性添加发布订阅的功能</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(data, key, &#123;</span><br><span class="line">        configurable: <span class="literal">true</span>,</span><br><span class="line">        enumerable: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 因为普通函数的this的指向为当前对象</span></span><br><span class="line">        <span class="comment">// 我们使用箭头函数将this指向函数定义在的对象里 </span></span><br><span class="line">        set: <span class="function">(<span class="params">newValue</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (newValue !== value) &#123;</span><br><span class="line">                <span class="comment">//给新的值添加get/set</span></span><br><span class="line">                <span class="built_in">this</span>.observer(newValue)</span><br><span class="line">                value = newValue</span><br><span class="line">                <span class="comment">// 数据修改时对数据进行更新</span></span><br><span class="line">                dep.notify()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="comment">// Dep.target 为 Dep对象、当Dep.target存在时将dep添加进Wacther的数组中</span></span><br><span class="line">            Dep.target &amp;&amp; dep.addSub(Dep.target)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建<code>Watcher</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-model 指令  node为元素节点、expr为表达式(people.name)、vm当前实例</span></span><br><span class="line"><span class="function"><span class="title">model</span>(<span class="params">node, expr, vm</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;modelUpdater&#x27;</span>]</span><br><span class="line">    <span class="comment">// 给input 赋予 value 属性 node.value = xxx</span></span><br><span class="line">    <span class="keyword">let</span> val = <span class="built_in">this</span>.getVal(vm, expr)</span><br><span class="line">    <span class="keyword">new</span> Watcher(vm, expr, <span class="function">(<span class="params">newValue</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 当数据更新时会调用这个方法对数据进行更新</span></span><br><span class="line">        fn(node, newValue)</span><br><span class="line">    &#125;)</span><br><span class="line">    node.addEventListener(<span class="string">&#x27;input&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setVal(vm, expr, event.target.value)</span><br><span class="line">    &#125;)</span><br><span class="line">    fn(node, val)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="function"><span class="title">html</span>(<span class="params">node, expr, vm</span>)</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;htmlUpdater&#x27;</span>]</span><br><span class="line">     <span class="comment">// 给input 赋予 value 属性 node.value = xxx</span></span><br><span class="line">     <span class="keyword">let</span> val = <span class="built_in">this</span>.getVal(vm, expr)</span><br><span class="line">     <span class="keyword">new</span> Watcher(vm, expr, <span class="function">(<span class="params">newValue</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="comment">// 当数据更新时会调用这个方法对数据进行更新</span></span><br><span class="line">         fn(node, newValue)</span><br><span class="line">     &#125;)</span><br><span class="line">     fn(node, val)</span><br><span class="line"> &#125;,</span><br><span class="line"><span class="function"><span class="title">getContentValue</span>(<span class="params">vm, expr</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 遍历表达式 &#123;&#123; peoele.name &#125;&#125; 将表达式替换成数据返回</span></span><br><span class="line">    <span class="keyword">return</span> expr.replace(<span class="regexp">/\&#123;\&#123;(.+?)\&#125;\&#125;/g</span>, <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getVal(vm, args[<span class="number">1</span>].trim())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="function"><span class="title">text</span>(<span class="params">node, expr, vm</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;textUpdater&#x27;</span>]</span><br><span class="line">    <span class="comment">// 通过 replace 将 &#123;&#123; people.name &#125;&#125; 替换为对应的值</span></span><br><span class="line">    <span class="keyword">let</span> content = expr.replace(<span class="regexp">/\&#123;\&#123;(.+?)\&#125;\&#125;/g</span>, <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> Watcher(vm, args[<span class="number">1</span>], <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            fn(node, <span class="built_in">this</span>.getContentValue(vm, expr))</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// args[1]: args 是一个数组、第二个参数是匹配到的内容</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getVal(vm, args[<span class="number">1</span>].trim())</span><br><span class="line">    &#125;)</span><br><span class="line">    fn(node, content)</span><br><span class="line">&#125;,    </span><br></pre></td></tr></table></figure><p>最终效果:</p><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg@master/img/20200808182949.png"></p><p>每个Dep中存放对应的值依赖</p><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg@master/img/20200808183836.png"></p><p>当数据改变时、会调用<code>dep.notify</code>通知 Dep 对象中的所有Wachter数据更新、这时Watcher的第三个参数: 回调函数就会修改数据了</p><h4 id="最终代码"><a href="#最终代码" class="headerlink" title="最终代码"></a>最终代码</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.$el = options.el</span><br><span class="line">        <span class="built_in">this</span>.$data = options.data</span><br><span class="line">        <span class="keyword">let</span> computed = options.computed</span><br><span class="line">        <span class="keyword">let</span> methods = options.methods</span><br><span class="line">        <span class="comment">// 我们需要判断 el 是否存在</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.$el) &#123;</span><br><span class="line">            <span class="comment">// 数据劫持</span></span><br><span class="line">            <span class="keyword">new</span> Observer(<span class="built_in">this</span>.$data)</span><br><span class="line">            <span class="comment">//计算属性</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> computed) &#123;</span><br><span class="line">                <span class="built_in">Object</span>.defineProperty(<span class="built_in">this</span>.$data, key, &#123;</span><br><span class="line">                    get: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> computed[key].call(<span class="built_in">this</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 方法</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> methods) &#123;</span><br><span class="line">                <span class="built_in">Object</span>.defineProperty(<span class="built_in">this</span>, key, &#123;</span><br><span class="line">                    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> methods[key]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 数据代理</span></span><br><span class="line">            <span class="built_in">this</span>.proxyData(<span class="built_in">this</span>.$data)</span><br><span class="line">            <span class="comment">//创建编译模板 传入 el 和 当前对象</span></span><br><span class="line">            <span class="keyword">new</span> Compile(<span class="built_in">this</span>.$el, <span class="built_in">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//代理 使得 通过 vue.people.name 访问和修改数据</span></span><br><span class="line">    <span class="function"><span class="title">proxyData</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> data) &#123;</span><br><span class="line">            <span class="built_in">Object</span>.defineProperty(<span class="built_in">this</span>, key, &#123;</span><br><span class="line">                configurable: <span class="literal">true</span>,</span><br><span class="line">                enumerable: <span class="literal">true</span>,</span><br><span class="line">                <span class="function"><span class="title">set</span>(<span class="params">newValue</span>)</span> &#123;</span><br><span class="line">                    data[key] = newValue</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> data[key]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//编译模板</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">el, vm</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 当用户传入 #app 与 document.querySelector(&#x27;#app&#x27;) 进行判断</span></span><br><span class="line">        <span class="built_in">this</span>.el = <span class="built_in">this</span>.isElementNode(el) ? el : <span class="built_in">document</span>.querySelector(el)</span><br><span class="line">        <span class="built_in">this</span>.vm = vm</span><br><span class="line">        <span class="comment">// 因为我们需要操作每个元素、频繁操作会导致页面回流重绘多次、避免发送需要把元素添加到内存中</span></span><br><span class="line">        <span class="keyword">let</span> fragment = <span class="built_in">this</span>.node2fragment(<span class="built_in">this</span>.el)</span><br><span class="line">        <span class="comment">// 把节点中需要替换的内容进行替换</span></span><br><span class="line">        <span class="comment">// 编译模板</span></span><br><span class="line">        <span class="built_in">this</span>.compile(fragment)</span><br><span class="line">        <span class="comment">// 再把内容放回页面</span></span><br><span class="line">        <span class="built_in">this</span>.el.appendChild(fragment)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断是否为元素节点</span></span><br><span class="line">    <span class="function"><span class="title">isElementNode</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// nodeType 为 1 是元素节点</span></span><br><span class="line">        <span class="keyword">return</span> node.nodeType === <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将el中的元素放入文档碎片(内存)中</span></span><br><span class="line">    <span class="function"><span class="title">node2fragment</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建文档碎片</span></span><br><span class="line">        <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line">        <span class="keyword">let</span> firstChild;</span><br><span class="line">        <span class="comment">// 通过每次获取第一个元素来将所有元素添加到文档碎片中</span></span><br><span class="line">        <span class="keyword">while</span> (firstChild = node.firstChild) &#123;</span><br><span class="line">            <span class="comment">// appendChild 具有移动性 可以将页面中的元素移动到文档碎片中</span></span><br><span class="line">            fragment.appendChild(firstChild)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fragment</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//编译模板</span></span><br><span class="line">    <span class="function"><span class="title">compile</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取子节点  返回的是一个伪数组</span></span><br><span class="line">        <span class="keyword">let</span> childNodes = node.childNodes; <span class="comment">// NodeList(7) [text, input, text, div, text, ul, text]</span></span><br><span class="line">        <span class="comment">// 通过...转成 数组</span></span><br><span class="line">        [...childNodes].forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//判断是为元素节点 如 &lt;input type=&quot;text&quot; v-model=&quot;people.name&quot;&gt;</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isElementNode(child)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.compileElementNode(child);</span><br><span class="line">                <span class="comment">// 如果是元素 需要判断自己的子节点 (递归)</span></span><br><span class="line">                <span class="built_in">this</span>.compile(child)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.compileText(child);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 编译元素</span></span><br><span class="line">    <span class="function"><span class="title">compileElementNode</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 返回的是一个伪数组</span></span><br><span class="line">        <span class="keyword">let</span> attributes = node.attributes;</span><br><span class="line">        [...attributes].forEach(<span class="function">(<span class="params">attr</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 通过解构复制获取 name(type) 和 value(text) </span></span><br><span class="line">            <span class="keyword">let</span> &#123; name, <span class="attr">value</span>: expr &#125; = attr;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isDirective(name)) &#123;</span><br><span class="line">                <span class="comment">//获取指令、 如 v-model 获取 model v-on:click</span></span><br><span class="line">                <span class="keyword">let</span> [, directive] = name.split(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">                <span class="keyword">let</span> [directiveName, eventName] = directive.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                CompileUtil[directiveName](node, expr.trim(), <span class="built_in">this</span>.vm, eventName)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 编译文本</span></span><br><span class="line">    <span class="function"><span class="title">compileText</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> content = node.textContent; <span class="comment">// 获取文本内容</span></span><br><span class="line">        <span class="comment">//匹配 &#123;&#123; xxx &#125;&#125; .+? 匹配(任意字符重复一次或更多次)再重复0次或一次避免匹配 &#123;&#123; aaa &#125;&#125; &#123;&#123; bbb &#125;&#125;</span></span><br><span class="line">        <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.+?)\&#125;\&#125;/</span>;</span><br><span class="line">        <span class="keyword">if</span> (reg.test(content)) &#123;</span><br><span class="line">            CompileUtil[<span class="string">&#x27;text&#x27;</span>](node, content, <span class="built_in">this</span>.vm)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断是否为指令</span></span><br><span class="line">    <span class="function"><span class="title">isDirective</span>(<span class="params">attrName</span>)</span> &#123;</span><br><span class="line">        <span class="comment">//ES6 语法 判断是否以 v- 开头</span></span><br><span class="line">        <span class="keyword">return</span> attrName.startsWith(<span class="string">&quot;v-&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//工具类替换模板内容</span></span><br><span class="line">CompileUtil = &#123;</span><br><span class="line">    <span class="function"><span class="title">getVal</span>(<span class="params">vm, expr</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> expr.split(<span class="string">&quot;.&quot;</span>).reduce(<span class="function">(<span class="params">data, current</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> data[current];</span><br><span class="line">        &#125;, vm.$data)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">setVal</span>(<span class="params">vm, expr, value</span>)</span> &#123;</span><br><span class="line">        expr.split(<span class="string">&quot;.&quot;</span>).reduce(<span class="function">(<span class="params">data, current, index, arr</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (index == arr.length - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> data[current] = value</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> data[current]</span><br><span class="line">        &#125;, vm.$data)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// v-model 指令  node为元素节点、expr为表达式(people.name)、vm当前实例</span></span><br><span class="line">    <span class="function"><span class="title">model</span>(<span class="params">node, expr, vm</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;modelUpdater&#x27;</span>]</span><br><span class="line">        <span class="comment">// 给input 赋予 value 属性 node.value = xxx</span></span><br><span class="line">        <span class="keyword">let</span> val = <span class="built_in">this</span>.getVal(vm, expr)</span><br><span class="line">        <span class="keyword">new</span> Watcher(vm, expr, <span class="function">(<span class="params">newValue</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 当数据更新时会调用这个方法对数据进行更新</span></span><br><span class="line">            fn(node, newValue)</span><br><span class="line">        &#125;)</span><br><span class="line">        node.addEventListener(<span class="string">&#x27;input&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setVal(vm, expr, event.target.value)</span><br><span class="line">        &#125;)</span><br><span class="line">        fn(node, val)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">on</span>(<span class="params">node, expr, vm, eventName</span>)</span> &#123;</span><br><span class="line">        node.addEventListener(eventName, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            vm[expr].call(vm, event)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">html</span>(<span class="params">node, expr, vm</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;htmlUpdater&#x27;</span>]</span><br><span class="line">        <span class="comment">// 给input 赋予 value 属性 node.value = xxx</span></span><br><span class="line">        <span class="keyword">let</span> val = <span class="built_in">this</span>.getVal(vm, expr)</span><br><span class="line">        <span class="keyword">new</span> Watcher(vm, expr, <span class="function">(<span class="params">newValue</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 当数据更新时会调用这个方法对数据进行更新</span></span><br><span class="line">            fn(node, newValue)</span><br><span class="line">        &#125;)</span><br><span class="line">        fn(node, val)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">getContentValue</span>(<span class="params">vm, expr</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 遍历表达式 &#123;&#123; peoele.name &#125;&#125; 将表达式替换成数据返回</span></span><br><span class="line">        <span class="keyword">return</span> expr.replace(<span class="regexp">/\&#123;\&#123;(.+?)\&#125;\&#125;/g</span>, <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getVal(vm, args[<span class="number">1</span>].trim())</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">text</span>(<span class="params">node, expr, vm</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fn = <span class="built_in">this</span>.updater[<span class="string">&#x27;textUpdater&#x27;</span>]</span><br><span class="line">        <span class="comment">// 通过 replace 将 &#123;&#123; people.name &#125;&#125; 替换为对应的值</span></span><br><span class="line">        <span class="keyword">let</span> content = expr.replace(<span class="regexp">/\&#123;\&#123;(.+?)\&#125;\&#125;/g</span>, <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> Watcher(vm, args[<span class="number">1</span>], <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                fn(node, <span class="built_in">this</span>.getContentValue(vm, expr))</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// args[1]: args 是一个数组、第二个参数是匹配到的内容</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getVal(vm, args[<span class="number">1</span>].trim())</span><br><span class="line">        &#125;)</span><br><span class="line">        fn(node, content)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//更新数据</span></span><br><span class="line">    updater: &#123;</span><br><span class="line">        <span class="function"><span class="title">modelUpdater</span>(<span class="params">node, value</span>)</span> &#123;</span><br><span class="line">            node.value = value;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">textUpdater</span>(<span class="params">node, value</span>)</span> &#123;</span><br><span class="line">            node.textContent = value</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">htmlUpdater</span>(<span class="params">node, value</span>)</span> &#123;</span><br><span class="line">            node.innerHTML = value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 改类实现数据劫持、添加set/get方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.observer(data)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">observer</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (data &amp;&amp; <span class="keyword">typeof</span> data == <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> data) &#123;</span><br><span class="line">                <span class="built_in">this</span>.defineRecative(key, data, data[key])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">defineRecative</span>(<span class="params">key, data, value</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.observer(value)</span><br><span class="line">        <span class="keyword">let</span> dep = <span class="keyword">new</span> Dep() <span class="comment">//给每个属性添加发布订阅的功能</span></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(data, key, &#123;</span><br><span class="line">            configurable: <span class="literal">true</span>,</span><br><span class="line">            enumerable: <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">// 因为普通函数的this的指向为当前对象</span></span><br><span class="line">            <span class="comment">// 我们使用箭头函数将this指向函数定义在的对象里 </span></span><br><span class="line">            set: <span class="function">(<span class="params">newValue</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (newValue !== value) &#123;</span><br><span class="line">                    <span class="comment">//给新的值添加get/set</span></span><br><span class="line">                    <span class="built_in">this</span>.observer(newValue)</span><br><span class="line">                    value = newValue</span><br><span class="line">                    dep.notify()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                Dep.target &amp;&amp; dep.addSub(Dep.target)</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this.$watch(&#x27;监听的数据&#x27;,(newValue,oldValue)=&gt;&#123;</span></span><br><span class="line"><span class="comment">//  </span></span><br><span class="line"><span class="comment">//&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// (观察者) 发布订阅模式</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">vm, expr, callback</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.vm = vm;</span><br><span class="line">        <span class="built_in">this</span>.expr = expr.trim();</span><br><span class="line">        <span class="built_in">this</span>.callback = callback</span><br><span class="line">        <span class="comment">// 保存变化之前的值</span></span><br><span class="line">        <span class="built_in">this</span>.oldValue = <span class="built_in">this</span>.get()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">//依赖注入 将 当前对象存入 Dep.target 中</span></span><br><span class="line">        Dep.target = <span class="built_in">this</span></span><br><span class="line">        <span class="keyword">let</span> value = CompileUtil.getVal(<span class="built_in">this</span>.vm, <span class="built_in">this</span>.expr)</span><br><span class="line">        Dep.target = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> newValue = CompileUtil.getVal(<span class="built_in">this</span>.vm, <span class="built_in">this</span>.expr)</span><br><span class="line">        <span class="keyword">if</span> (newValue != <span class="built_in">this</span>.oldValue) &#123;</span><br><span class="line">            <span class="built_in">this</span>.callback(newValue)</span><br><span class="line">            <span class="built_in">this</span>.oldValue = newValue</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于通知观察者更新数据</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">//用于存放 Watcher</span></span><br><span class="line">        <span class="built_in">this</span>.subs = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将观察者添加进一个数组里</span></span><br><span class="line">    <span class="function"><span class="title">addSub</span>(<span class="params">watcher</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subs.push(watcher)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通知每个 watcher进行数据更新</span></span><br><span class="line">    <span class="function"><span class="title">notify</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subs.forEach(<span class="function">(<span class="params">watcher</span>) =&gt;</span> watcher.update())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>代码: <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/vuejs/vue/tree/v2.6.11">https://github.com/vuejs/vue/tree/v2.6.11</a></p><p>我们从 <code>new Vue</code>的时候开始分析(执行 new Vue 时会依次执行以下方法):</p><ol><li><p><code>Vue.prototype._init(option)</code></p></li><li><p><code>initState(vm)</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码位置 https://github.com/vuejs/vue/blob/v2.6.11/src/core/instance/state.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initState</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  vm._watchers = []</span><br><span class="line">  <span class="keyword">const</span> opts = vm.$options</span><br><span class="line">  <span class="keyword">if</span> (opts.props) initProps(vm, opts.props)</span><br><span class="line">  <span class="keyword">if</span> (opts.methods) initMethods(vm, opts.methods)</span><br><span class="line">  <span class="keyword">if</span> (opts.data) &#123;</span><br><span class="line">     <span class="comment">// 有数据就会执行 initData方法</span></span><br><span class="line">    initData(vm)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    observe(vm._data = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.computed) initComputed(vm, opts.computed)</span><br><span class="line">  <span class="keyword">if</span> (opts.watch &amp;&amp; opts.watch !== nativeWatch) &#123;</span><br><span class="line">    initWatch(vm, opts.watch)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = vm.$options.data</span><br><span class="line">  data = vm._data = <span class="keyword">typeof</span> data === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    ? getData(data, vm)</span><br><span class="line">    : data || &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (!isPlainObject(data)) &#123;</span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; warn(</span><br><span class="line">      <span class="string">&#x27;data functions should return an object:\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&#x27;</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// proxy data on instance</span></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(data)</span><br><span class="line">  <span class="keyword">const</span> props = vm.$options.props</span><br><span class="line">  <span class="keyword">const</span> methods = vm.$options.methods</span><br><span class="line">  <span class="keyword">let</span> i = keys.length</span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (methods &amp;&amp; hasOwn(methods, key)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has already been defined as a data property.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (props &amp;&amp; hasOwn(props, key)) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; warn(</span><br><span class="line">        <span class="string">`The data property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already declared as a prop. `</span> +</span><br><span class="line">        <span class="string">`Use prop default value instead.`</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isReserved(key)) &#123;</span><br><span class="line">      <span class="comment">// 1. data属性代理</span></span><br><span class="line">      proxy(vm, <span class="string">`_data`</span>, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// observe data</span></span><br><span class="line">  <span class="comment">// 2.对data调用observe  </span></span><br><span class="line">  observe(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>1.中</code>通过 while 循环内调用<code>proxy</code>函数把data的属性代理到vue实例上。之后可以通过 <code>vue.key</code> 访问到 <code>data.key</code></li><li><code>2.中</code> 之后对data调用<code>observe</code>方法、数据将会变成响应式</li></ul></li><li><p><code>observe(vm._data)</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/vuejs/vue/blob/v2.6.11/src/core/observer/index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">observe</span> (<span class="params">value: any, asRootData: ?boolean</span>): <span class="title">Observer</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(value) || value <span class="keyword">instanceof</span> VNode) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> ob: Observer | <span class="keyword">void</span></span><br><span class="line">  <span class="keyword">if</span> (hasOwn(value, <span class="string">&#x27;__ob__&#x27;</span>) &amp;&amp; value.__ob__ <span class="keyword">instanceof</span> Observer) &#123;</span><br><span class="line">    ob = value.__ob__</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">// 3.检测当前的数据是否是对象或者数组，如果是，则生成对应的Observer  </span></span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !isServerRendering() &amp;&amp;</span><br><span class="line">    (<span class="built_in">Array</span>.isArray(value) || isPlainObject(value)) &amp;&amp;</span><br><span class="line">    <span class="built_in">Object</span>.isExtensible(value) &amp;&amp;</span><br><span class="line">    !value._isVue</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 3. </span></span><br><span class="line">    ob = <span class="keyword">new</span> Observer(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.vmCount++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>3.中</code>对传入的数据对象进行了判断、只对<code>对象和数组类型</code>生成Observer</p></li><li><p><code>new Observer(data)</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码位置: https://github.com/vuejs/vue/blob/v2.6.11/src/core/observer/observer.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  value: any;</span><br><span class="line">  dep: Dep;</span><br><span class="line">  vmCount: number; <span class="comment">// number of vms that have this object as root $data</span></span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span> (<span class="params">value: any</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.value = value</span><br><span class="line">    <span class="comment">// 生成了一个消息订阅器dep实例 关于dep的结构稍后详细介绍   </span></span><br><span class="line">    <span class="built_in">this</span>.dep = <span class="keyword">new</span> Dep()</span><br><span class="line">    <span class="built_in">this</span>.vmCount = <span class="number">0</span></span><br><span class="line">    <span class="comment">// def函数给当前数据添加不可枚举的__ob__属性，表示该数据已经被observe过  </span></span><br><span class="line">    def(value, <span class="string">&#x27;__ob__&#x27;</span>, <span class="built_in">this</span>)</span><br><span class="line">    <span class="comment">// 4.对数组类型的数据 调用observeArray方法；对对象类型的数据，调用walk方法  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">        protoAugment(value, arrayMethods)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        copyAugment(value, arrayMethods, arrayKeys)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.observeArray(value)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.walk(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Walk through all properties and convert them into</span></span><br><span class="line"><span class="comment">   * getter/setters. This method should only be called when</span></span><br><span class="line"><span class="comment">   * value type is Object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  walk (obj: <span class="built_in">Object</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">      defineReactive(obj, keys[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Observe a list of Array items.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">/* observe数组类型数据的每个值， */</span></span><br><span class="line">  observeArray (items: <span class="built_in">Array</span>&lt;any&gt;) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.length; i &lt; l; i++) &#123;</span><br><span class="line">      observe(items[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* defineReactive的核心思想改写数据的getter和setter */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  obj: <span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  val: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  customSetter?: ?<span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  shallow?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 生成一个dep实例，注意此处的dep和前文Observer类里直接添加的dep的区别  </span></span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep()</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 检验该属性是否允许重新定义setter和getter</span></span><br><span class="line">  <span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, key)</span><br><span class="line">  <span class="keyword">if</span> (property &amp;&amp; property.configurable === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cater for pre-defined getter/setters</span></span><br><span class="line">  <span class="comment">// 获取原有的 getter/setters  </span></span><br><span class="line">  <span class="keyword">const</span> getter = property &amp;&amp; property.get</span><br><span class="line">  <span class="keyword">const</span> setter = property &amp;&amp; property.set</span><br><span class="line">  <span class="keyword">if</span> ((!getter || setter) &amp;&amp; <span class="built_in">arguments</span>.length === <span class="number">2</span>) &#123;</span><br><span class="line">    val = obj[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 此处对val进行了observe</span></span><br><span class="line">  <span class="keyword">let</span> childOb = !shallow &amp;&amp; observe(val)</span><br><span class="line">  <span class="comment">// 下面的代码利用Object.defineProperty函数把数据转化成getter和setter，并且在getter和setter时，进行了一些操作</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span> <span class="title">reactiveGetter</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">      <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">        <span class="comment">// dep.depend()其实就是dep和watcher进行了互相绑定，而Dep.target表示需要绑定的那个watcher，任何时刻都最多只有一个，后面还会解释  </span></span><br><span class="line">        dep.depend()</span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          <span class="comment">// 当前对象的子对象的依赖也要被收集  </span></span><br><span class="line">          childOb.dep.depend()</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">            dependArray(value)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span> <span class="title">reactiveSetter</span> (<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">      <span class="comment">/* eslint-disable no-self-compare */</span></span><br><span class="line">      <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* eslint-enable no-self-compare */</span></span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; customSetter) &#123;</span><br><span class="line">        customSetter()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// #7981: for accessor properties without setter</span></span><br><span class="line">      <span class="keyword">if</span> (getter &amp;&amp; !setter) <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">        setter.call(obj, newVal)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 观察新的val并通知订阅者们属性有更新  </span></span><br><span class="line">      childOb = !shallow &amp;&amp; observe(newVal)</span><br><span class="line">      dep.notify()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Observer类代码中，首先给当前数据添加了一个dep实例，存放于对象或者数组类型数据的，然后把<code>_ob_</code>挂在该数据上</p><p>它是该数据项被observe的标志、可以看的每个data上都有<code>_ob_</code>(observe只对对象和数组有效)</p><p>随后，对于数组和对象类型的数据做不同处理：</p><ul><li><p>对于数组类型的数: 调用<code>observeArray</code>方法</p></li><li><p>对于对象，我们执行<code>walk()</code>方法，而就是对于当前数据对象的每个key，执行<code>defineReactive()</code>方法、这个方法就是给data添加get/set方法</p><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg@master/img/20200808220338.png" alt="图解"></p></li></ul></li><li><p>接下来看一下dep</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码位置: https://github.com/vuejs/vue/blob/v2.6.11/src/core/observer/observer.js</span></span><br><span class="line"><span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A dep is an observable that can have multiple</span></span><br><span class="line"><span class="comment"> * directives subscribing to it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> target: ?Watcher;</span><br><span class="line">  id: number;</span><br><span class="line">  subs: <span class="built_in">Array</span>&lt;Watcher&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.id = uid++</span><br><span class="line">    <span class="built_in">this</span>.subs = []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加一个watcher</span></span><br><span class="line">  addSub (sub: Watcher) &#123;</span><br><span class="line">    <span class="built_in">this</span>.subs.push(sub)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 移除一个watcher</span></span><br><span class="line">  removeSub (sub: Watcher) &#123;</span><br><span class="line">    remove(<span class="built_in">this</span>.subs, sub)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 让当前watcher收集依赖 同时Dep.target.addDep也会触发当前dep收集watcher</span></span><br><span class="line">  depend () &#123;</span><br><span class="line">    <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">      Dep.target.addDep(<span class="built_in">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 通知watcher们对应的数据有更新</span></span><br><span class="line">  notify () &#123;</span><br><span class="line">    <span class="comment">// stabilize the subscriber list first</span></span><br><span class="line">    <span class="keyword">const</span> subs = <span class="built_in">this</span>.subs.slice()</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !config.async) &#123;</span><br><span class="line">      subs.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.id - b.id)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.length; i &lt; l; i++) &#123;</span><br><span class="line">      subs[i].update()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个类有两个属性：</p><ul><li><p>第一个是id，在每个vue实例中都从0开始计数</p></li><li><p>另一个是<code>subs</code>数组，用于存放<code>wacther</code></p><p>前面我们知道: 一个数据对应一个Dep，所以<code>subs</code> 里存放的也就是依赖该数据需要绑定的wacther</p><p><code>Dep.target</code>属性是全局共享的，表示当前在收集依赖的那个Watcher，在每个时刻最多只会有一个</p></li></ul></li><li><p>接下来看一下watcher</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码位置: https://github.com/vuejs/vue/blob/v2.6.11/src/core/observer/watcher.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  vm: Component;</span><br><span class="line">  expression: string;</span><br><span class="line">  cb: <span class="built_in">Function</span>;</span><br><span class="line">  id: number;</span><br><span class="line">  deep: boolean;</span><br><span class="line">  user: boolean;</span><br><span class="line">  lazy: boolean;</span><br><span class="line">  sync: boolean;</span><br><span class="line">  dirty: boolean;</span><br><span class="line">  active: boolean;</span><br><span class="line">  deps: <span class="built_in">Array</span>&lt;Dep&gt;;</span><br><span class="line">  newDeps: <span class="built_in">Array</span>&lt;Dep&gt;;</span><br><span class="line">  depIds: SimpleSet;</span><br><span class="line">  newDepIds: SimpleSet;</span><br><span class="line">  before: ?<span class="built_in">Function</span>;</span><br><span class="line">  getter: <span class="built_in">Function</span>;</span><br><span class="line">  value: any;</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span> (<span class="params"></span></span><br><span class="line"><span class="params">    vm: Component,</span></span><br><span class="line"><span class="params">    expOrFn: string | <span class="built_in">Function</span>,</span></span><br><span class="line"><span class="params">    cb: <span class="built_in">Function</span>,</span></span><br><span class="line"><span class="params">    options?: ?<span class="built_in">Object</span>,</span></span><br><span class="line"><span class="params">    isRenderWatcher?: boolean</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.vm = vm</span><br><span class="line">    <span class="keyword">if</span> (isRenderWatcher) &#123;</span><br><span class="line">      vm._watcher = <span class="built_in">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    vm._watchers.push(<span class="built_in">this</span>)</span><br><span class="line">    <span class="comment">// options</span></span><br><span class="line">    <span class="keyword">if</span> (options) &#123;</span><br><span class="line">      <span class="built_in">this</span>.deep = !!options.deep</span><br><span class="line">      <span class="built_in">this</span>.user = !!options.user</span><br><span class="line">      <span class="built_in">this</span>.lazy = !!options.lazy</span><br><span class="line">      <span class="built_in">this</span>.sync = !!options.sync</span><br><span class="line">      <span class="built_in">this</span>.before = options.before</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.deep = <span class="built_in">this</span>.user = <span class="built_in">this</span>.lazy = <span class="built_in">this</span>.sync = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.cb = cb</span><br><span class="line">    <span class="built_in">this</span>.id = ++uid <span class="comment">// uid for batching</span></span><br><span class="line">    <span class="built_in">this</span>.active = <span class="literal">true</span></span><br><span class="line">    <span class="built_in">this</span>.dirty = <span class="built_in">this</span>.lazy <span class="comment">// for lazy watchers</span></span><br><span class="line">    <span class="built_in">this</span>.deps = []</span><br><span class="line">    <span class="built_in">this</span>.newDeps = []</span><br><span class="line">    <span class="built_in">this</span>.depIds = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">    <span class="built_in">this</span>.newDepIds = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">    <span class="built_in">this</span>.expression = process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span></span><br><span class="line">      ? expOrFn.toString()</span><br><span class="line">      : <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">// parse expression for getter</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.getter = expOrFn</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.getter = parsePath(expOrFn)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.getter) &#123;</span><br><span class="line">        <span class="built_in">this</span>.getter = noop</span><br><span class="line">        process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; warn(</span><br><span class="line">          <span class="string">`Failed watching path: &quot;<span class="subst">$&#123;expOrFn&#125;</span>&quot; `</span> +</span><br><span class="line">          <span class="string">&#x27;Watcher only accepts simple dot-delimited paths. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;For full control, use a function instead.&#x27;</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.value = <span class="built_in">this</span>.lazy</span><br><span class="line">      ? <span class="literal">undefined</span></span><br><span class="line">      : <span class="built_in">this</span>.get()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Evaluate the getter, and re-collect dependencies.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  get () &#123;</span><br><span class="line">    pushTarget(<span class="built_in">this</span>)</span><br><span class="line">    <span class="keyword">let</span> value</span><br><span class="line">    <span class="keyword">const</span> vm = <span class="built_in">this</span>.vm</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      value = <span class="built_in">this</span>.getter.call(vm, vm)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.user) &#123;</span><br><span class="line">        handleError(e, vm, <span class="string">`getter for watcher &quot;<span class="subst">$&#123;<span class="built_in">this</span>.expression&#125;</span>&quot;`</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> e</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// &quot;touch&quot; every property so they are all tracked as</span></span><br><span class="line">      <span class="comment">// dependencies for deep watching</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.deep) &#123;</span><br><span class="line">        traverse(value)</span><br><span class="line">      &#125;</span><br><span class="line">      popTarget()</span><br><span class="line">      <span class="built_in">this</span>.cleanupDeps()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Add a dependency to this directive.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  addDep (dep: Dep) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = dep.id</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.newDepIds.has(id)) &#123;</span><br><span class="line">      <span class="built_in">this</span>.newDepIds.add(id)</span><br><span class="line">      <span class="built_in">this</span>.newDeps.push(dep)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.depIds.has(id)) &#123;</span><br><span class="line">        dep.addSub(<span class="built_in">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Clean up for dependency collection.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  cleanupDeps () &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="built_in">this</span>.deps.length</span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> dep = <span class="built_in">this</span>.deps[i]</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.newDepIds.has(dep.id)) &#123;</span><br><span class="line">        dep.removeSub(<span class="built_in">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> tmp = <span class="built_in">this</span>.depIds</span><br><span class="line">    <span class="built_in">this</span>.depIds = <span class="built_in">this</span>.newDepIds</span><br><span class="line">    <span class="built_in">this</span>.newDepIds = tmp</span><br><span class="line">    <span class="built_in">this</span>.newDepIds.clear()</span><br><span class="line">    tmp = <span class="built_in">this</span>.deps</span><br><span class="line">    <span class="built_in">this</span>.deps = <span class="built_in">this</span>.newDeps</span><br><span class="line">    <span class="built_in">this</span>.newDeps = tmp</span><br><span class="line">    <span class="built_in">this</span>.newDeps.length = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Subscriber interface.</span></span><br><span class="line"><span class="comment">   * Will be called when a dependency changes.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  update () &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.lazy) &#123;</span><br><span class="line">      <span class="built_in">this</span>.dirty = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.sync) &#123;</span><br><span class="line">      <span class="built_in">this</span>.run()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      queueWatcher(<span class="built_in">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Scheduler job interface.</span></span><br><span class="line"><span class="comment">   * Will be called by the scheduler.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  run () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.active) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = <span class="built_in">this</span>.get()</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        value !== <span class="built_in">this</span>.value ||</span><br><span class="line">        <span class="comment">// Deep watchers and watchers on Object/Arrays should fire even</span></span><br><span class="line">        <span class="comment">// when the value is the same, because the value may</span></span><br><span class="line">        <span class="comment">// have mutated.</span></span><br><span class="line">        isObject(value) ||</span><br><span class="line">        <span class="built_in">this</span>.deep</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// set new value</span></span><br><span class="line">        <span class="keyword">const</span> oldValue = <span class="built_in">this</span>.value</span><br><span class="line">        <span class="built_in">this</span>.value = value</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.user) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.cb.call(<span class="built_in">this</span>.vm, value, oldValue)</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            handleError(e, <span class="built_in">this</span>.vm, <span class="string">`callback for watcher &quot;<span class="subst">$&#123;<span class="built_in">this</span>.expression&#125;</span>&quot;`</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.cb.call(<span class="built_in">this</span>.vm, value, oldValue)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Evaluate the value of the watcher.</span></span><br><span class="line"><span class="comment">   * This only gets called for lazy watchers.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  evaluate () &#123;</span><br><span class="line">    <span class="built_in">this</span>.value = <span class="built_in">this</span>.get()</span><br><span class="line">    <span class="built_in">this</span>.dirty = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Depend on all deps collected by this watcher.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  depend () &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="built_in">this</span>.deps.length</span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">      <span class="built_in">this</span>.deps[i].depend()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Remove self from all dependencies&#x27; subscriber list.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  teardown () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.active) &#123;</span><br><span class="line">      <span class="comment">// remove self from vm&#x27;s watcher list</span></span><br><span class="line">      <span class="comment">// this is a somewhat expensive operation so we skip it</span></span><br><span class="line">      <span class="comment">// if the vm is being destroyed.</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.vm._isBeingDestroyed) &#123;</span><br><span class="line">        remove(<span class="built_in">this</span>.vm._watchers, <span class="built_in">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> i = <span class="built_in">this</span>.deps.length</span><br><span class="line">      <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="built_in">this</span>.deps[i].removeSub(<span class="built_in">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.active = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>watcher用于watcher用来<code>解析表达式</code>，收集依赖，并且当表达式的值改变时触发回调函数，用在<code>$watch()</code> api 和指令之中。</p><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg@master/img/20200808224749.png"></p></li><li><p>模板渲染</p><p>这里的分析来自: <a target="_blank" rel="noopener external nofollow noreferrer" href="https://zhuanlan.zhihu.com/p/168768245">https://zhuanlan.zhihu.com/p/168768245</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// new Vue 执行流程。</span></span><br><span class="line"><span class="comment">// 1. Vue.prototype._init(option)</span></span><br><span class="line"><span class="comment">// 2. vm.$mount(vm.$options.el)</span></span><br><span class="line"><span class="comment">// 3. render = compileToFunctions(template) ，编译 Vue 中的 template 模板，生成 render 方法。</span></span><br><span class="line"><span class="comment">// 4. Vue.prototype.$mount 调用上面的 render 方法挂载 dom。</span></span><br><span class="line"><span class="comment">// 5. mountComponent</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. 创建 Watcher 实例</span></span><br><span class="line"><span class="keyword">const</span> updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  vm._update(vm._render());</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 结合上文，我们就能得出，updateComponent 就是传入 Watcher 内部的 getter 方法。</span></span><br><span class="line"><span class="keyword">new</span> Watcher(vm, updateComponent);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. new Watcher 会执行 Watcher.get 方法</span></span><br><span class="line"><span class="comment">// 8. Watcher.get 会执行 this.getter.call(vm, vm) ，也就是执行 updateComponent 方法</span></span><br><span class="line"><span class="comment">// 9. updateComponent 会执行 vm._update(vm._render())</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 10. 调用 vm._render 生成虚拟 dom</span></span><br><span class="line">Vue.prototype._render = <span class="function"><span class="keyword">function</span> (<span class="params"></span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vm: Component = <span class="built_in">this</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; render &#125; = vm.$options;</span><br><span class="line">  <span class="keyword">let</span> vnode = render.call(vm._renderProxy, vm.$createElement);</span><br><span class="line">  <span class="keyword">return</span> vnode;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 11. 调用 vm._update(vnode) 渲染虚拟 dom</span></span><br><span class="line">Vue.prototype._update = <span class="function"><span class="keyword">function</span> (<span class="params">vnode: VNode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vm: Component = <span class="built_in">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">    <span class="comment">// 初次渲染</span></span><br><span class="line">    vm.$el = vm.__patch__(vm.$el, vnode, hydrating, <span class="literal">false</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    vm.$el = vm.__patch__(prevVnode, vnode);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 12. vm.__patch__ 方法就是做的 dom diff 比较，然后更新 dom，这里就不展开了。</span></span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg@master/img/20200808230055.png"></p><p>到这里，我们就知道了 Watcher 其实是在 Vue 初始化的阶段创建的，属于生命周期中 beforeMount 的位置创建的，创建 Watcher 时会执行 render 方法，最终将 Vue 代码渲染成真实的 DOM。</p></li></ol><p>最后附上了一张图:同样来自<a target="_blank" rel="noopener external nofollow noreferrer" href="https://zhuanlan.zhihu.com/p/168768245">https://zhuanlan.zhihu.com/p/168768245</a></p><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg@master/img/20200808224343.png"></p><p>到这里、Vue响应式的原理就差不多明白了、虽然还是很菜、呜呜呜。</p><p>参考资料:</p><ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://segmentfault.com/a/1190000012612657">从源码解析vue响应式原理</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://zhuanlan.zhihu.com/p/168768245">图解 Vue 响应式原理</a></li></ul></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">卓越科技-</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://blog.imzykj.cn/posts/a9e8a85d/">https://blog.imzykj.cn/posts/a9e8a85d/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.imzykj.cn" target="_blank">卓越科技的Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Vue/">Vue</a></div><div class="post_share"><div class="social-share" data-image="https://tva4.sinaimg.cn/large/9bd9b167gy1fwrtnow7fgj21hc0u0nki.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg/img/alipay.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg/img/alipay.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg/img/wechat.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg/img/wechat.png" alt="微信"></a><div class="post-qr-code-desc">微信</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/e400c46/"><img class="prev-cover" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://tva4.sinaimg.cn/large/9bd9b167gy1g4lifhuoeoj21hc0xchdt.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Nuxt.js 学习</div></div></a></div><div class="next-post pull-right"><a href="/posts/42ed6352/"><img class="next-cover" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://tva4.sinaimg.cn/large/9bd9b167ly1fwsfucs1hrj21hc0u01kx.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Vue仿蘑菇街项目</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i> <span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/22686bb0/" title="Vue-CLI学习"><img class="cover" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg/img/vueclistudy-cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-27</div><div class="title">Vue-CLI学习</div></div></a></div><div><a href="/posts/f9d8baf9/" title="Vue.js进阶"><img class="cover" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg/img/vuestudy2-cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-09</div><div class="title">Vue.js进阶</div></div></a></div><div><a href="/posts/413c71da/" title="Vuex学习"><img class="cover" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjimg/img/vuexstudy-cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-11</div><div class="title">Vuex学习</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB"><span class="toc-number">1.</span> <span class="toc-text">Vue响应式原理解读</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Object-defineProperty"><span class="toc-number">1.1.</span> <span class="toc-text">Object.defineProperty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">观察者模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96Vue"><span class="toc-number">1.3.1.</span> <span class="toc-text">初始化Vue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.3.2.</span> <span class="toc-text">编译模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81"><span class="toc-number">1.3.3.</span> <span class="toc-text">数据劫持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%BB%A3%E7%90%86"><span class="toc-number">1.3.4.</span> <span class="toc-text">数据代理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.5.</span> <span class="toc-text">发布订阅模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.6.</span> <span class="toc-text">最终代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.4.</span> <span class="toc-text">源码分析</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image:url(https://tva4.sinaimg.cn/large/9bd9b167gy1fwrtnow7fgj21hc0u0nki.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 卓越科技-</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">CDN BY <a target="_blank" href="https://www.jsdelivr.com/" rel="external nofollow noreferrer" data-pjax-state=""><b>jsDelivr</b></a> | HOST BY <a target="_blank" href="https://vercel.com/" rel="external nofollow noreferrer"><b>Vercel</b></a> &amp;&amp; <a target="_blank" href="https://coding.net/" rel="external nofollow noreferrer"><b>Coding</b></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjofficial.github.io@master/js/utils.js"></script><script src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjofficial.github.io@master/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){GLOBAL_CONFIG_SITE.isPost&&panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><script src="https://cdn.jsdelivr.net/gh/zykjofficial/zykjresource@master/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const t=document.getElementById("twikoo-count"),o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"twikoo-4g2ypman52a24a4b",region:""},null))},e=()=>{twikoo.getCommentsCount({envId:"twikoo-4g2ypman52a24a4b",region:"",urls:[window.location.pathname],includeReply:!1}).then((function(o){t.innerText=o[0].count})).catch((function(t){console.error(t)}))},n=(n=!1)=>{"object"==typeof twikoo?(o(),n&&t&&setTimeout(e,0)):getScript("https://cdn.jsdelivr.net/npm/twikoo@beta/dist/twikoo.all.min.js").then(()=>{o(),n&&t&&setTimeout(e,0)})};btf.loadComment(document.getElementById("twikoo-wrap"),n)})()</script></div><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>🚀 网站已更新最新版本 📑</label> <a href="javascript:void(0)" rel="external nofollow noreferrer" onclick="location.reload()">点我更新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"🚀 博客已更新最新版本 🌍",backgroundColor:t,duration:5e5,pos:e,actionText:"点我更新⚡",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/catchcat/"]):not([href="/shuoshuo/"]):not([href="/music/"]):not([href="/about/"]):not([href="/friendcircle/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.removeEventListener("scroll",window.tocScrollFn),"object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script></div></body></html>